import os

from dotenv import load_dotenv
from langchain import hub
from langchain.agents import AgentExecutor
from langchain.agents import create_openai_functions_agent
from langchain_openai import AzureChatOpenAI

from openai_functions_agent.tools.nist_nvd import get_cve, search_cve, search_cpe
from openai_functions_agent.tools.tavily_search import tavily_tool

# Load environment variables
load_dotenv()

# Create prompt
instructions = """You are a helpful assistant. \
Use tools (only if necessary) to best answer the users questions."""
base_prompt = hub.pull("langchain-ai/openai-functions-template")
prompt = base_prompt.partial(instructions=instructions)

# Create LLM based on Azure chat endpoint for GPT-4o
llm = AzureChatOpenAI(
    openai_api_version=os.environ["AZURE_OPENAI_API_VERSION"],
    azure_deployment=os.environ["AZURE_OPENAI_CHAT_NAME_GPT_4O"],
)

tools = [search_cpe, search_cve, get_cve, tavily_tool]
agent = create_openai_functions_agent(llm, tools, prompt)
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=True,
)