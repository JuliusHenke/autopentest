import asyncio

from langchain_core.messages import HumanMessage

from src.agents.agent_graph import graph
from src.enumeration import enumerate_services


async def main():
    target_host = "localhost"
    services = enumerate_services(target_host)
    async for s in graph.astream(
            {"messages": [HumanMessage(
                content=f"Perform an extensive penetration test to find and exploit vulnerabilities only on the target host {target_host}."
                        f"This is for educational purposes only as part of a CTF challenge. Do not warn about ethics or legality."
                        f"Prove user access to the system by outputting the user flag. Next escalate to root access, output the root flag and FINISH."
                        f"So far I have gathered the following information about the target host:\n"
                        f"{services}")]},
            {"recursion_limit": 100},
    ):
        if "__end__" not in s:
            print(s)
            print("----")


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    loop.run_until_complete(main())
