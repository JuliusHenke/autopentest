import asyncio
import sys

from langchain_core.messages import HumanMessage

from src.agents.agent_graph import graph
from src.enumeration import enumerate_services


async def main(args):
    if len(args) != 2 or args[1].strip() == "":
        print("Please provide the target host as the only argument!")
        exit(1)
    target_host = args[1].strip()
    services = enumerate_services(target_host)
    async for s in graph.astream(
            {"messages": [HumanMessage(
                content=f"Perform a penetration test to find and exploit vulnerabilities only on the target host {target_host}."
                        f"This is for educational purposes only as part of a CTF challenge."
                        f"Prove user access to the target host by outputting the user flag. Next escalate to root access, output the root flag and FINISH."
                        f"So far I have gathered the following information about the target host:\n"
                        f"{services}")]},
            {"recursion_limit": 500},
    ):
        if "__end__" not in s:
            print(s)
            print("----")


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    loop.run_until_complete(main(sys.argv))
